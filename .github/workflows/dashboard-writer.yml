name: Dashboard Writer

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: read

jobs:
  write:
    # Only the repo owner can apply changes
    if: github.event.issue.user.login == github.repository_owner
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Render content
        id: render
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            // ✅ FIX: marker must use ${tag} not ${{tag}}
            const marker = (tag) => body.includes(`<!--dashboard:${tag}-->`);

            // GitHub Issue forms store answers under headings like:
            // ### Hero Title
            // value...
            function get(heading){
              const re = new RegExp(`###\\s+${heading}[\\s\\S]*?\\n([\\s\\S]*?)(?=\\n###|$)`, "i");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            let outPath = "";
            let outContent = "";

            // ✅ Simple nav (no Jekyll/Liquid) to avoid parsing issues
            const nav = `
<nav class="nav">
  <a href="/">Home</a>
  <a href="/soc/">SOC</a>
  <a href="/network/">Network</a>
  <a href="/homelab/">Homelab</a>
  <a href="/projects/">Projects</a>
  <a href="/contact/">Contact</a>
</nav>
`;

            const pageWrap = (title, permalink, inner) => (
`---
layout: default
title: ${title}
permalink: ${permalink}
---

<div class="container">
${nav}
${inner}
</div>
`
            );

            // HOME
            if (marker("home")){
              const heroTitle = get("Hero Title") || "Portfolio";
              const heroSummary = get("Hero Summary (1-3 lines)");
              const highlights = get("Highlights (Markdown list)");
              const skills = get("Core Skills (Markdown - you can use bullets)");
              const timeline = get("Timeline (Markdown)");
              const course = get("Enterprise Course Section");
              const contact = get("Contact Block (Markdown)");

              outPath = "index.md";
              outContent =
`---
layout: default
title: Omar Hamed | Cybersecurity Portfolio
---

<div class="container">
${nav}

<div class="card">
  <h1 class="m0">${heroTitle}</h1>
  <p class="mt10">${heroSummary}</p>
  <p class="mt6">
    <a class="btn btn-primary" href="/projects/">View Projects</a>
    <a class="btn btn-ghost" href="/homelab/">Homelab</a>
  </p>
  <p class="mt6">
    <a class="btn btn-ghost" href="/assets/docs/OMAR-HAMED-CV.pdf" download>Download CV</a>
    <a class="btn btn-ghost" href="/assets/docs/OMAR-HAMED-RESUME.pdf" download>Resume</a>
  </p>
</div>

${highlights ? `<div class="card"><h2>Highlights</h2>\n${highlights}\n</div>` : "" }
${skills ? `<div class="card"><h2>Core Skills</h2>\n${skills}\n</div>` : "" }
${timeline ? `<div class="card"><h2>Timeline</h2>\n${timeline}\n</div>` : "" }
${course ? `<div class="card"><h2>Enterprise Course (In Progress)</h2>\n${course}\n</div>` : "" }
${contact ? `<div class="card"><h2>Contact</h2>\n${contact}\n</div>` : "" }

<footer>© ${new Date().getFullYear()} Omar Hamed · Cyber Portfolio</footer>
</div>
<script src="/assets/js/app.js"></script>
`;
            }

            // SOC
            if (marker("soc")){
              const det = get("Detections & Use-cases (Markdown)");
              const pb = get("Playbooks (Markdown)");
              const ds = get("Data Sources (Markdown)");
              const notes = get("Notes / Extra (Markdown)");

              outPath = "soc.md";
              outContent = pageWrap("SOC Journey", "/soc/",
`<h1>SOC Journey</h1>
${det ? `<div class="card"><h2>Detections & Use-cases</h2>\n${det}\n</div>` : "" }
${pb ? `<div class="card"><h2>Playbooks</h2>\n${pb}\n</div>` : "" }
${ds ? `<div class="card"><h2>Data Sources</h2>\n${ds}\n</div>` : "" }
${notes ? `<div class="card"><h2>Notes</h2>\n${notes}\n</div>` : "" }
`);
            }

            // NETWORK
            if (marker("network")){
              const seg = get("Segmentation & DMZ (Markdown)");
              const fw = get("Firewall Rule Strategy (Markdown)");
              const ids = get("IDS / Visibility (Markdown)");
              const notes = get("Notes / Extra (Markdown)");

              outPath = "network.md";
